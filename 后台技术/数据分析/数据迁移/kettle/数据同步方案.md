[TOC]

## 需求背景

最近公司要做数据中台相关的业务，由于我们的业务数据库是异构数据库，一部分数据在mysql，一部分数据在sqlserver，所以需要一种技术方案解决将数据从异构的数据库抽取出来，然后清洗数据，最后同步到数据中台。

## 解决方案

由于把数据从OLTP（可以理解为业务数据库）转换加载到OLAP（可以理解为数据仓库或者数据中台），这个过程其实是ETL的过程。

而业内ETL的解决方案有很多，我采取的是开源软件--->Kettle

为什么选择Kettle

- kettle是开源的，免费的
- kettle是java编写的，多平台公用
- kettle支持集群，高可用
- kettle有图形界面，相对于对使用者来说简单，并且拥有各种组件，从何实现各种数据的可能性
- kettle支持异构的数据源
- kettle支持数据同步失败之后的机制（比如邮件）

## 方案分析

接下来，我们来说明kettle是如何做数据增量同步

### 前置工作

1. Kettle软件下载。  https://sourceforge.net/projects/pentaho/files/   

   - 推荐下载8.2版本（2018年版本），最新版本9.2 不稳定，运行经常卡死（踩坑了）

2. 相应的数据库驱动

   - mysql  https://dev.mysql.com/downloads/connector/j/
   - sqlserver

   

### 方案基础前提

需要一个同步的表有一个更新时间的字段，根据这个字段去做增量同步。

### 方案思路

1. 建一个中间表，记录更新的时间戳

2. 根据时间戳赛选比这个时间戳大的数据

3. 通过时间戳，拿到原表与目标表在此时间之后的数据，然后对比

   - 原表存在，目标表不存在---> 新增

   - 原表不存在，目标表存在---> 删除

   - 原表存在，目标表存在，有字段更新---> 更新

   - 原表存在，目标表存在，无字段更新---> 不作任何操作

4. 根据步骤3的规则同步数据

5. 同步完之后将目标表最新的时间更新到这个中间表的时间戳以作为下次同步的依据

### 存在的问题

能解决时间戳之后的数据的新增/修改/删除的数据，但是解决不了时间戳之前删除的数据（**如果有逻辑删除字段，则没有这个问题**）

所以要设置一个全局变量 回滚时间

根据这个回滚时间，和时间戳相运算(比如时间戳是2022/4/8   回滚时间是2天，那么最终拿去运用的时间戳是 2022/4/6)，然后同步最终运算后的时间戳的数据。

**所以能做到相对数据一致性，做不到绝对数据一致性。**

## 总结

该方案适合数据一致性，不是很强的数据同步。

